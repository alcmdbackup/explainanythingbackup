# Reddit-Style Comments Planning

## 1. Background

ExplainAnything is an AI-powered educational content platform where users search topics and receive AI-generated explanations. Currently, users can save explanations to their library and provide feedback through tags. Adding a Reddit-style comments system will enable richer community engagement, allowing users to discuss, ask questions, and share insights directly on explanations.

## 2. Problem

Users currently have no way to discuss explanations with each other. The only interaction is saving to library or modifying tags. A threaded comments system would allow users to ask clarifying questions, share additional context, correct errors, and build community around content. This aligns with the product principle of "Maximize Feedback" to algorithmically improve content.

## 3. Options Considered

### Data Model Options

| Model | Read | Write | Chosen |
|-------|------|-------|--------|
| Adjacency List (parent_id only) | O(n) recursive | O(1) | No - slow reads |
| Materialized Path | O(1) with LIKE | O(depth) | **Yes - hybrid** |
| Nested Sets | O(1) | O(n) | No - complex writes |
| Closure Table | O(1) | O(depth) | No - over-engineered |

**Decision**: Hybrid Adjacency List + Materialized Path
- `parent_id` for simple navigation
- `path` (e.g., "1.5.12") for efficient subtree queries

### Vote Storage Options

| Approach | Pros | Cons | Chosen |
|----------|------|------|--------|
| Calculate on read | Always accurate | Slow for large threads | No |
| Denormalized counts + triggers | Fast reads | Slight write overhead | **Yes** |
| Background job aggregation | Decoupled | Eventually consistent | No |

**Decision**: Denormalized with triggers - vote counts stored on comments, updated via triggers

## 4. Phased Execution Plan

### Phase 1: Database Schema & Migration
**Files to create:**
- `supabase/migrations/20260102000001_comments_system.sql`

**Implementation:**
```sql
-- comments table
CREATE TABLE public.comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  explanation_id BIGINT NOT NULL REFERENCES public.explanations(id) ON DELETE CASCADE,
  parent_id BIGINT REFERENCES public.comments(id) ON DELETE CASCADE,
  author_id UUID NOT NULL,
  path TEXT NOT NULL,
  depth SMALLINT NOT NULL DEFAULT 0 CHECK (depth >= 0 AND depth <= 10),
  content TEXT NOT NULL CHECK (char_length(content) <= 10000),
  upvotes INTEGER NOT NULL DEFAULT 0,
  downvotes INTEGER NOT NULL DEFAULT 0,
  net_score INTEGER GENERATED ALWAYS AS (upvotes - downvotes) STORED,
  is_deleted BOOLEAN NOT NULL DEFAULT FALSE,
  is_edited BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- comment_votes table
CREATE TABLE public.comment_votes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  comment_id BIGINT NOT NULL REFERENCES public.comments(id) ON DELETE CASCADE,
  user_id UUID NOT NULL,
  vote_value SMALLINT NOT NULL CHECK (vote_value IN (-1, 1)),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(comment_id, user_id)
);

-- Indexes, RLS, triggers (see full migration)
```

**Verification:** Run migration locally, verify tables in Supabase Studio

---

### Phase 2: Zod Schemas
**Files to create:**
- `src/lib/schemas/commentSchemas.ts`

**Implementation:**
- `commentInsertSchema` - insert fields only
- `commentFullDbSchema` - extends with DB-generated fields
- `commentUISchema` - extends with user_vote and replies[]
- `voteSchema`, `commentSortModeSchema`

**Verification:** TypeScript compilation passes

---

### Phase 3: Service Layer
**Files to create:**
- `src/lib/services/comments.ts`
- `src/lib/services/commentVotes.ts`

**Key functions:**
```typescript
// comments.ts
createComment(data, authorId): Promise<CommentFullDbType>
getCommentsForExplanation(explanationId, userId, sortMode): Promise<CommentUIType[]>
updateComment(commentId, userId, newContent): Promise<CommentFullDbType>
deleteComment(commentId, userId): Promise<void>

// commentVotes.ts
castVote(commentId, userId, voteValue): Promise<VoteValue | null>
getUserVotesForComments(commentIds, userId): Promise<Map<number, VoteValue>>
```

**Verification:** Unit tests pass

---

### Phase 4: Server Actions
**Files to create:**
- `src/actions/commentActions.ts`

**Actions:**
- `createCommentAction`, `getCommentsAction`, `updateCommentAction`
- `deleteCommentAction`, `castVoteAction`

**Verification:** TypeScript compilation, action tests pass

---

### Phase 5: Frontend State
**Files to create:**
- `src/reducers/commentsReducer.ts`
- `src/hooks/useComments.ts`

**Reducer actions:**
- LOAD_COMMENTS, SET_LOADING, SET_ERROR, SET_SORT_MODE
- TOGGLE_COLLAPSE, SET_REPLYING_TO, SET_EDITING
- ADD_COMMENT, UPDATE_COMMENT, DELETE_COMMENT, UPDATE_VOTE

**Verification:** Reducer unit tests pass

---

### Phase 6: UI Components
**Files to create:**
- `src/components/comments/CommentsSection.tsx`
- `src/components/comments/CommentList.tsx`
- `src/components/comments/Comment.tsx`
- `src/components/comments/CommentForm.tsx`
- `src/components/comments/CommentVotes.tsx`
- `src/components/comments/CommentActions.tsx`

**Integration point:**
- Add `<CommentsSection>` to `src/app/results/page.tsx`

**Verification:** Manual testing on localhost, component tests pass

---

### Phase 7: Testing
**Files to create:**
- `src/lib/services/comments.test.ts`
- `src/lib/services/commentVotes.test.ts`
- `src/reducers/commentsReducer.test.ts`
- `src/__tests__/integration/comments.integration.test.ts`
- `src/__tests__/e2e/specs/07-comments/*.spec.ts`
- `src/__tests__/e2e/helpers/pages/CommentsPage.ts`

**Verification:** All test suites pass

---

### Phase 8: Documentation
**Files to update:**
- `docs/docs_overall/architecture.md` - Add comments to Feature Systems
- `docs/feature_deep_dives/comments.md` (new) - Full documentation

**Verification:** Docs reviewed

## 5. Testing

### Unit Tests
| File | Coverage |
|------|----------|
| `comments.test.ts` | createComment, getCommentsForExplanation, updateComment, deleteComment, buildCommentTree |
| `commentVotes.test.ts` | castVote (insert/update/toggle), getUserVotesForComments |
| `commentsReducer.test.ts` | All reducer actions, tree manipulation helpers |

### Integration Tests
| File | Coverage |
|------|----------|
| `comments.integration.test.ts` | Full CRUD flow, voting persistence, RLS enforcement |

### E2E Tests
| File | Coverage |
|------|----------|
| `comment-crud.spec.ts` | Create, read, edit, delete comments |
| `comment-voting.spec.ts` | Upvote, downvote, toggle, score display |
| `comment-threading.spec.ts` | Reply chains, collapse/expand, depth limit |

## 6. Documentation Updates

| File | Updates |
|------|---------|
| `docs/docs_overall/architecture.md` | Add Comments System to Feature Systems section |
| `docs/feature_deep_dives/comments.md` | New file: schema, API, component docs |
